#!/usr/bin/env ruby

# å¼€å‘ç¯å¢ƒä¸€é”®å¯åŠ¨è„šæœ¬
# å¯åŠ¨æœåŠ¡ï¼šRailsæœåŠ¡å™¨ + Solid Queue + æ•°æ®åº“å‡†å¤‡

require 'fileutils'
require 'open3'

puts "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒæœåŠ¡..."
puts "=" * 50

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
def port_in_use?(port)
  system("lsof -i:#{port} > /dev/null 2>&1")
end

# æ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹
def kill_port_process(port)
  puts "ğŸ” æ£€æŸ¥ç«¯å£ #{port} æ˜¯å¦è¢«å ç”¨..."
  if port_in_use?(port)
    puts "âš ï¸  ç«¯å£ #{port} è¢«å ç”¨ï¼Œæ­£åœ¨ç»ˆæ­¢ç›¸å…³è¿›ç¨‹..."
    system("lsof -ti:#{port} | xargs kill -9 2>/dev/null")
    sleep 2
  end
end

# æ£€æŸ¥å¹¶å‡†å¤‡æ•°æ®åº“
def setup_database
  puts "ğŸ“¦ æ£€æŸ¥æ•°æ®åº“..."
  
  # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
  unless File.exist?('storage/development.sqlite3')
    puts "ğŸ—„ï¸  åˆ›å»ºå¼€å‘æ•°æ®åº“..."
    system('bin/rails db:create')
  end
  
  puts "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
  system('bin/rails db:migrate')
  
  # å‡†å¤‡é˜Ÿåˆ—æ•°æ®åº“
  puts "ğŸ”„ å‡†å¤‡é˜Ÿåˆ—æ•°æ®åº“..."
  system('bin/rails db:migrate:queue')
  
  # å‡†å¤‡ç¼“å­˜æ•°æ®åº“
  puts "ğŸ”„ å‡†å¤‡ç¼“å­˜æ•°æ®åº“..."
  system('bin/rails db:migrate:cache')
  
  # å‡†å¤‡Cableæ•°æ®åº“
  puts "ğŸ”„ å‡†å¤‡Cableæ•°æ®åº“..."
  system('bin/rails db:migrate:cable')
end

# å¯åŠ¨Solid Queue
def start_solid_queue
  puts "âš™ï¸  å¯åŠ¨ Solid Queue..."
  pid = spawn('bin/jobs')
  Process.detach(pid)
  puts "âœ… Solid Queue å·²å¯åŠ¨ (PID: #{pid})"
  pid
end

# å¯åŠ¨RailsæœåŠ¡å™¨
def start_rails_server
  puts "ğŸš‚ å¯åŠ¨ Rails æœåŠ¡å™¨..."
  puts "ğŸ“ è®¿é—®åœ°å€: http://localhost:3000"
  
  # ä½¿ç”¨execæ¥æ›¿æ¢å½“å‰è¿›ç¨‹ï¼Œè¿™æ ·Ctrl+Cå¯ä»¥æ­£å¸¸åœæ­¢
  exec('bin/rails', 'server', '-b', '0.0.0.0', '-p', '3000')
end

# ä¸»æµç¨‹
begin
  # æ¸…ç†ç«¯å£
  kill_port_process(3000)
  kill_port_process(45678) # Solid Queueé»˜è®¤ç«¯å£
  
  # è®¾ç½®æ•°æ®åº“
  setup_database
  
  # å¯åŠ¨Solid Queue
  queue_pid = start_solid_queue
  
  # ç­‰å¾…é˜Ÿåˆ—æœåŠ¡å¯åŠ¨
  sleep 3
  
  # å¯åŠ¨RailsæœåŠ¡å™¨ï¼ˆè¿™ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼‰
  start_rails_server
  
rescue Interrupt
  puts "\nğŸ›‘ æ­£åœ¨åœæ­¢æœåŠ¡..."
  
  # åœæ­¢Solid Queue
  if defined?(queue_pid)
    begin
      Process.kill('TERM', queue_pid)
      puts "âœ… Solid Queue å·²åœæ­¢"
    rescue Errno::ESRCH
      puts "âš ï¸  Solid Queue è¿›ç¨‹ä¸å­˜åœ¨"
    end
  end
  
  puts "ğŸ‘‹ å¼€å‘ç¯å¢ƒæœåŠ¡å·²åœæ­¢"
  exit 0
end