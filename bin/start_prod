#!/usr/bin/env ruby

# ç”Ÿäº§ç¯å¢ƒä¸€é”®å¯åŠ¨è„šæœ¬
# å¯åŠ¨æœåŠ¡ï¼šRailsæœåŠ¡å™¨ï¼ˆåŒ…å«Solid Queueï¼‰+ ç¯å¢ƒæ£€æŸ¥

require 'fileutils'
require 'open3'

puts "ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒæœåŠ¡..."
puts "=" * 50

# æ£€æŸ¥æ˜¯å¦åœ¨ç”Ÿäº§ç¯å¢ƒ
def check_production_env
  if ENV['RAILS_ENV'] != 'production'
    puts "âš ï¸  è­¦å‘Š: å½“å‰ç¯å¢ƒä¸æ˜¯ production (RAILS_ENV=#{ENV['RAILS_ENV'] || 'æœªè®¾ç½®'})"
    print "æ˜¯å¦ç»§ç»­å¯åŠ¨? (y/N): "
    response = gets.chomp.downcase
    unless response == 'y'
      puts "âŒ å–æ¶ˆå¯åŠ¨"
      exit 1
    end
  end
end

# æ£€æŸ¥å¿…è¦çš„ç”Ÿäº§ç¯å¢ƒé…ç½®
def check_production_setup
  puts "ğŸ” æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®..."
  
  # æ£€æŸ¥master key
  unless File.exist?('config/master.key')
    puts "âŒ é”™è¯¯: ç¼ºå°‘ config/master.key æ–‡ä»¶"
    puts "è¯·ç¡®ä¿ RAILS_MASTER_KEY ç¯å¢ƒå˜é‡å·²è®¾ç½®æˆ– config/master.key æ–‡ä»¶å­˜åœ¨"
    exit 1
  end
  
  # æ£€æŸ¥æ•°æ®åº“
  unless File.exist?('storage/production.sqlite3')
    puts "ğŸ—„ï¸  åˆ›å»ºç”Ÿäº§æ•°æ®åº“..."
    system('bin/rails db:create')
  end
  
  puts "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®æ£€æŸ¥å®Œæˆ"
end

# å‡†å¤‡æ•°æ®åº“
def setup_database
  puts "ğŸ“¦ å‡†å¤‡ç”Ÿäº§æ•°æ®åº“..."
  
  puts "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
  unless system('bin/rails db:migrate')
    puts "âŒ æ•°æ®åº“è¿ç§»å¤±è´¥"
    exit 1
  end
  
  # å‡†å¤‡é˜Ÿåˆ—æ•°æ®åº“
  puts "ğŸ”„ å‡†å¤‡é˜Ÿåˆ—æ•°æ®åº“..."
  unless system('bin/rails db:migrate:queue')
    puts "âŒ é˜Ÿåˆ—æ•°æ®åº“è¿ç§»å¤±è´¥"
    exit 1
  end
  
  # å‡†å¤‡ç¼“å­˜æ•°æ®åº“
  puts "ğŸ”„ å‡†å¤‡ç¼“å­˜æ•°æ®åº“..."
  unless system('bin/rails db:migrate:cache')
    puts "âŒ ç¼“å­˜æ•°æ®åº“è¿ç§»å¤±è´¥"
    exit 1
  end
  
  # å‡†å¤‡Cableæ•°æ®åº“
  puts "ğŸ”„ å‡†å¤‡Cableæ•°æ®åº“..."
  unless system('bin/rails db:migrate:cable')
    puts "âŒ Cableæ•°æ®åº“è¿ç§»å¤±è´¥"
    exit 1
  end
  
  puts "âœ… æ•°æ®åº“å‡†å¤‡å®Œæˆ"
end

# ç¼–è¯‘èµ„äº§
def compile_assets
  puts "ğŸ“¦ ç¼–è¯‘ç”Ÿäº§èµ„äº§..."
  
  # æ¸…ç†æ—§èµ„äº§
  system('bin/rails assets:clobber')
  
  # é¢„ç¼–è¯‘èµ„äº§
  unless system('bin/rails assets:precompile')
    puts "âŒ èµ„äº§ç¼–è¯‘å¤±è´¥"
    exit 1
  end
  
  puts "âœ… èµ„äº§ç¼–è¯‘å®Œæˆ"
end

# å¯åŠ¨RailsæœåŠ¡å™¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
def start_rails_server
  puts "ğŸš‚ å¯åŠ¨ Rails ç”Ÿäº§æœåŠ¡å™¨..."
  puts "ğŸ“ è®¿é—®åœ°å€: http://localhost:3000"
  puts "âš¡ Solid Queue å°†åœ¨ Puma è¿›ç¨‹ä¸­è¿è¡Œ"
  
  # è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
  ENV['SOLID_QUEUE_IN_PUMA'] = 'true'
  
  # ä½¿ç”¨execæ¥æ›¿æ¢å½“å‰è¿›ç¨‹ï¼Œè¿™æ ·Ctrl+Cå¯ä»¥æ­£å¸¸åœæ­¢
  exec('bin/rails', 'server', '-b', '0.0.0.0', '-p', '3000', '-e', 'production')
end

# æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
def show_status
  puts ""
  puts "ğŸ¯ ç”Ÿäº§ç¯å¢ƒçŠ¶æ€:"
  puts "   â€¢ ç¯å¢ƒ: #{ENV['RAILS_ENV'] || 'production'}"
  puts "   â€¢ æ•°æ®åº“: SQLite (storage/production.sqlite3)"
  puts "   â€¢ é˜Ÿåˆ—: Solid Queue (é›†æˆåœ¨Pumaä¸­)"
  puts "   â€¢ ç¼“å­˜: Solid Cache"
  puts "   â€¢ Cable: Solid Cable"
  puts ""
  puts "ğŸ“‹ å¯ç”¨å‘½ä»¤:"
  puts "   â€¢ æŸ¥çœ‹æ—¥å¿—: tail -f log/production.log"
  puts "   â€¢ é‡å¯æœåŠ¡: Ctrl+C ç„¶åé‡æ–°è¿è¡Œè„šæœ¬"
  puts "   â€¢ è¿›å…¥æ§åˆ¶å°: bin/rails console"
  puts ""
  puts "ğŸš€ æ­£åœ¨å¯åŠ¨æœåŠ¡..."
  puts "=" * 50
end

# ä¸»æµç¨‹
begin
  # æ£€æŸ¥ç¯å¢ƒ
  check_production_env
  
  # æ£€æŸ¥é…ç½®
  check_production_setup
  
  # å‡†å¤‡æ•°æ®åº“
  setup_database
  
  # ç¼–è¯‘èµ„äº§ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦ï¼‰
  compile_assets
  
  # æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
  show_status
  
  # å¯åŠ¨RailsæœåŠ¡å™¨ï¼ˆè¿™ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼‰
  start_rails_server
  
rescue Interrupt
  puts "\nğŸ›‘ æ­£åœ¨åœæ­¢æœåŠ¡..."
  puts "ğŸ‘‹ ç”Ÿäº§ç¯å¢ƒæœåŠ¡å·²åœæ­¢"
  exit 0
rescue => e
  puts "âŒ é”™è¯¯: #{e.message}"
  exit 1
end